apiVersion: apps/v1
kind: Deployment
metadata:
  name: pinit-task
  namespace: pinit
  labels:
    app: pinit-task
spec:
  replicas: 2
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: pinit-task

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  template:
    metadata:
      labels:
        app: pinit-task
    spec:
      imagePullSecrets:
        - name: ghcr-pull-secret
      terminationGracePeriodSeconds: 30
      volumes:
        - name: keys
          secret:
            secretName: pinit-keys
            defaultMode: 0400
      containers:
        - name: app
          image: ghcr.io/pinit-scheduler/pinit-task/app:${GITHUB_SHA} # GITHUB_SHA 환경변수는 GitHub Actions에서 설정되며 envsubst로 치환됩니다.
          imagePullPolicy: IfNotPresent

          env:
            - name: SPRING_PROFILES_ACTIVE
              value: prod

          volumeMounts:
            - mountPath: /etc/keys
              name: keys
              readOnly: true


          ports:
            - name: http
              containerPort: 8080
            - name: grpc
              containerPort: 9090

          envFrom:
            - secretRef:
                name: pinit-task-secret

          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 6

          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 2
            failureThreshold: 3

          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"

          lifecycle:
            preStop:
              exec:
                command: [ "sh", "-c", "sleep 5" ]
