# 지난 Task 모아보기(완료 + 마감일 3일 경과) API 체크리스트

> 목적: 마감일 기준 3일 이상 지난 완료 Task를 커서 기반으로 모아볼 수 있는 클라이언트용 엔드포인트를 추가한다.

## 요구 정의

- [ ] "3일" 기준을 확정한다: **마감일 + 3일 00:00(사용자 오프셋 적용 여부 포함)** 으로 컷오프 계산 방식을 확정한다.
- [ ] 포함 범위를 정의한다: 일정과 연결된 Task/미연결 Task 모두 포함 여부를 정리한다(전제: 모든 Task는 마감일을 가진다).
- [ ] 정렬 방향과 기본/최대 페이지 크기를 확정한다(예: `deadline DESC, id DESC`, default 20, max 100) 및 커서 포맷(`deadlineDate|taskId`)을 명세한다.
- [ ] 응답 필드 확정: `deadline` 표기 방식(오프셋 포함 여부)과 완료 소스(직접 완료/일정 완료) 노출 여부를 결정하고 프론트 합의.
- [ ] 기존 Task 목록 API와의 역할 분리를 명문화한다(기본 목록에서는 최근 Task까지 포함, 아카이브는 마감일 3일 경과 + 완료만 포함).

## 스키마 & 도메인

- [ ] 도메인에서 마감일(`TemporalConstraint.deadline`)을 손쉽게 `LocalDate`로 얻을 수 있는 헬퍼를 검토한다(이미 제공되면 재사용).
- [ ] 3일 컷오프 계산 시 사용될 오프셋을 명시하고, DDD 규칙에 맞는 도메인/서비스 책임 배분을 정리한다.
- [ ] DB 인덱스 필요 여부를 검토한다: `(owner_id, completed, deadline_date)` 복합 인덱스 추가 여부 결정 및 마이그레이션 스크립트 준비.

## 레포지토리 & 쿼리

- [ ] `TaskRepository`에 완료 Task 전용 커서 쿼리를 추가한다: `completed=true`, `deadline_date <= cutoffDate`, 정렬
  `deadline_date DESC, id DESC`.
- [ ] 커서 인코딩/디코딩 포맷을 정의한다(`yyyy-MM-dd|{id}` 기본, 오프셋 적용 시 `yyyy-MM-ddXXX|{id}`) 및 파싱 실패 예외 메시지를 규격화한다.
- [ ] 커서 단위 테스트/통합 테스트로 동일 마감일 + ID 타이브레이킹이 안정적으로 동작하는지 검증한다.

## 서비스 & 애플리케이션 레이어

- [ ] 3일 컷오프 계산 방식을 구현한다(마감일을 사용자 오프셋 기준 LocalDate로 변환 후 `plusDays(3)` 비교) 및 테스트 시 고정 now/offset 주입 가능하도록 설계한다.
- [ ] `TaskService`에 아카이브용 커서 페이지 모델을 추가하고 `hasNext`/`nextCursor` 계산을 DESC 정렬에 맞게 구현한다.
- [ ] 완료→재오픈 시 아카이브 대상에서 제외되도록 completed 플래그와 상태 변경 이벤트 일관성을 점검한다.

## API 계약 & 컨트롤러

- [ ] V2 이상에 `GET /v2/tasks/completed`(커서 기반) 엔드포인트를 추가하고 파라미터(`size`, `cursor`, `offset?`) 검증 규칙을 정의한다.
- [ ] 응답 DTO를 설계한다: `TaskArchiveResponse`(Task 기본 정보 + `deadline`) 신설 또는 `TaskResponseV2` 확장 여부 결정, 직렬화 스냅샷 추가.
- [ ] Swagger/OAS 문서를 업데이트하고 커서 예제(`deadline|id`), 3일 컷오프 설명, 에러 응답(`400` 잘못된 커서/사이즈) 명세를 반영한다.
- [ ] Member 인증/인가(`@MemberId`) 적용 및 레이트 리밋/응답 캐싱 필요 여부를 결정한다.

## 테스트

- [ ] 도메인 단위: deadline LocalDate 추출/비교 유틸이 3일 컷오프 규칙을 만족하는지 검증한다.
- [ ] 리포지토리 통합: 커서 쿼리 정렬/필터/hasNext 계산, 3일 컷오프 경계(정확히 3일) 테스트를 추가한다.
- [ ] 서비스 단위: 커서 직렬화/역직렬화, 잘못된 커서 예외, size 상한, cutoff 계산(오프셋 적용)을 검증한다.
- [ ] 컨트롤러: 요청 검증(음수/0 size, 잘못된 커서), 응답 스키마 스냅샷, 권한 필터 적용 여부를 확인한다.
- [ ] 이벤트/로그: 아카이브 조회 트래킹을 추가했다면 직렬화 필드 검증을 포함한다.

## 배포 & 운영

- [ ] 스키마 변경이 없거나 인덱스 추가만 필요한지 확정하고, 필요 시 DDL 적용 순서를 문서화한다.
- [ ] 운영/스테이징에서 `ddl-auto=update` 설정 유무에 따른 위험을 점검하고, 인덱스 추가 시 수동 DDL 실행 계획을 마련한다.
- [ ] 모니터링 포인트 정의: 아카이브 API latency/에러율, 응답 건수 추이, 마감일 null 비율 알람, 큐 이벤트 지연 여부.
- [ ] 프런트/모바일 팀 공지: 커서 포맷, 3일 기준 시간대/오프셋, 최대 페이지 크기, 응답 필드 변경 사항을 릴리스 노트에 반영한다.
