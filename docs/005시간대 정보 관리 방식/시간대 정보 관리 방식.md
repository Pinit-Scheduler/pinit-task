# 시간대 정보 관리 체크리스트 (순서형)

사용자별 시간대를 올바르게 처리하기 위해 단계별로 진행할 수 있는 체크리스트다. 위에서 아래로 내려가며 항목을 확인/수정하면 된다.

## 0. 현행 상태 점검 (2026-02-01 기준)

- [x] DB 커넥션 `serverTimezone=UTC` 설정 확인 (`application-dev.yml`, `application-prod.yml`).
- [x] 회원 기본 TZ가 `Asia/Seoul`로 하드코딩됨 (`MemberService#enrollMember`) → 가입 시 전달된 IANA TZ 저장으로 교체.
- [x] 마감/데일리 VO가 `LocalDate + ZoneOffset`만 저장 (`ZonedDateAttribute`, `TemporalConstraint`) → ZoneId 보존 설계/마이그레이션 완료.
- [x] DTO 불일치: `DateWithOffset`(Offset만) vs `DateTimeWithZone`(ZoneId 포함) → ZoneId 포함 DTO로 통일.
- [x] `findZoneOffsetOfMember`가 `Instant.now()` 기준으로 오프셋 산출 → 이벤트 시각 기준 오프셋 계산 API/유틸 보강.

## 1. 회원 시간대 수집·보관 준비

- [x] 회원 `timeZone` 필드는 **IANA Zone ID**(예: `Asia/Seoul`, `America/Los_Angeles`)를 “단일 진실 값”으로 저장한다. 기본값 하드코딩 금지,
  `UTC+09:00` 같은 오프셋 문자열을 `zoneId` 자리에 넣지 않는다.
- [x] 클라이언트가 보내는 TZ + 오프셋을 검증 후 저장(유효한 IANA인지 확인).

## 2. 도메인·DB 정비

- [x] 모든 시간 컬럼을 UTC로 저장한다. MySQL 사용 시 `DATETIME(6)`+UTC 해석 컨버터(`InstantToDatetime6UtcConverter`) 적용.
- [x] 반복 일정/리마인더: 로컬 시간(사용자 TZ)으로 정의를 저장, 전개 시 UTC 발생 시각 생성.
- [x] 마감·데일리 값은 IANA Zone ID를 함께 저장해 언제든 정확한 오프셋을 다시 계산할 수 있게 한다. 오프셋(`+09:00`)은 필요 시 파생 캐시로만 사용한다.

## 3. API 계약 및 버전 관리

- [x] 요청/응답 DTO에 시간대 정보를 필수 포함(가급적 ZoneId, 최소 Offset). `DateWithOffset`/`DateTimeWithZone` 등 스키마를 통일.
- [x] “특정 날짜의 모든 일정/작업” 요청은 사용자 TZ 기준 하루 시작/끝을 계산해 `startUtc`/`endUtc` 범위로 쿼리. (일정: UTC 범위 적용, 작업: zoneId 필터로 정렬 완료)
- [x] “특정 주차(week) 조회”도 동일하게 사용자 TZ에서 주 시작/끝을 구해 UTC 범위로 변환한다. 주 시작 요일(ISO 월요일 등)을 스키마/문서로 명시하고 서버·클라가 동일 규칙을 사용하도록 한다.
- [x] DST로 하루/주 길이가 달라질 수 있으니 `LocalDate → ZonedDateTime → Instant`로 구간 계산.
- [x] 시간·스키마 규칙이 바뀌면 컨트롤러 버전 상승(`TaskControllerV3` 등) 및 `OpenApiConfig.info.version` 동시 갱신.

## 4. 서비스·유틸 및 쿼리/배치 구현

- [x] 공용 변환 유틸/서비스(`TimeZoneConverter` 등)로 TZ ↔ UTC 변환을 일원화하고 테스트 가능하게 유지.
- [x] 오프셋 계산은 이벤트 시각 기준으로 수행하는 함수 제공(단순 `Instant.now()` 의존 제거).
- [x] 배치/스케줄러는 UTC 기준 트리거 또는 `zone="UTC"` 명시; 사용자 로컬 시간 기반 작업은 TZ 버킷별로 UTC 시간 계산.
- [x] 리트라이·지연 큐가 UTC 단위로 처리되는지 확인.

## 5. 프런트엔드 연동

- [ ] 클라이언트에서 IANA TZ와 오프셋을 함께 전송하고, 받은 UTC를 로컬 TZ로 렌더링.
- [ ] 디바이스 TZ 변경 시 오프라인/캐시 데이터가 재계산되는지 확인.

## 6. 테스트·모니터링·마이그레이션

- [x] 단위 테스트: 변환 유틸의 TZ·DST 파라미터화 케이스.
- [x] 통합 테스트: 서로 다른 TZ 계정으로 동일 이벤트가 다른 시각에 보이는지 검증.
- [x] 로그/메트릭에 `requesterTimeZone`, `computedUtc`, `renderedLocal` 등을 남겨 디버깅 가능하게 한다.
- [x] ZoneId 추가나 컬럼 타입 변경이 필요하면 마이그레이션/백필 계획을 수립하고 적용.

## 7. V2 API 호환성 메모

- 일정 조회 V2 (`/v2/schedules`, `/v2/schedules/week`)는 `LocalDateTime + ZoneId`를 받으므로 상기 규칙과 일치.
- 작업 생성/수정 V2는 `마감 LocalDate + ZoneOffset`을 요구: 체크리스트의 “가급적 ZoneId, 최소 Offset” 범위 안에 있으나, ZoneId 기반으로 전환 시 컨트롤러 버전업 필요.
- 작업 마감일 조회 V2 (`/v2/tasks/by-deadline`)는 `LocalDate`만 받음: 사용자 TZ 입력 없이 저장된 Offset에 의존. 체크리스트 3단계(날짜 조회는 TZ→UTC 범위 변환)에
  맞추려면 신규 버전에서 TZ 입력을 추가해야 함.
- 작업 완료 아카이브 V2 (`/v2/tasks/completed`)는 Optional `offset`을 받고, 없으면 `findZoneOffsetOfMember(now)`를 사용: 이벤트 시각 기준 오프셋
  계산으로 교체하거나, ZoneId 입력을 받는 버전으로 승격 필요.
- 일반 목록/커서 조회 V2는 회원 프로필의 현재 Offset을 사용해 “오늘”을 계산하는 구조: DST/미래 일정 정확도를 높이려면 TZ + 기준 시각을 받아 계산하도록 차기 버전에서 수정.
